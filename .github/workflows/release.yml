name: Release

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  # Comprehensive pre-release testing across all platforms
  pre-release-test:
    name: Pre-release test ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos
            arch: arm64
            runner: macos-14
          - os: macos
            arch: x86_64
            runner: macos-13
          - os: linux
            arch: x86_64
            runner: ubuntu-latest
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm64
          - os: windows
            arch: x86_64
            runner: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install system dependencies (Linux)
      if: matrix.os == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libclang-dev

    # Test with latest LightGBM version
    - name: Build and test (latest LightGBM)
      run: |
        cargo build --release --verbose
        cargo test --release --verbose
        cargo build --release --features polars-support --verbose
        cargo test --release --features polars-support --verbose

    # Build all examples
    - name: Build examples
      run: |
        cargo build --release --example basic_usage
        cargo build --release --example advanced_usage
        cargo build --release --example polars_usage --features polars-support

    # Archive release artifacts
    - name: Archive artifacts (Unix)
      if: matrix.os != 'windows'
      run: |
        mkdir -p artifacts
        cp target/release/lib_lightgbm.* artifacts/ || true
        tar -czf lightgbm-rust-${{ matrix.os }}-${{ matrix.arch }}.tar.gz artifacts/

    - name: Archive artifacts (Windows)
      if: matrix.os == 'windows'
      run: |
        New-Item -ItemType Directory -Force -Path artifacts
        Copy-Item target/release/lib_lightgbm.* artifacts/ -ErrorAction SilentlyContinue
        Compress-Archive -Path artifacts/* -DestinationPath lightgbm-rust-${{ matrix.os }}-${{ matrix.arch }}.zip

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lightgbm-rust-${{ matrix.os }}-${{ matrix.arch }}
        path: |
          lightgbm-rust-${{ matrix.os }}-${{ matrix.arch }}.*

  # Upload artifacts to the release
  upload-release-artifacts:
    name: Upload Release Artifacts
    needs: pre-release-test
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Upload artifacts to release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/**/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Publish to crates.io
  publish:
    name: Publish to crates.io
    needs: pre-release-test
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && !github.event.release.prerelease
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Publish to crates.io
      run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

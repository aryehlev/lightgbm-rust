name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test ${{ matrix.os }} (${{ matrix.arch }}) - LightGBM ${{ matrix.lightgbm_version }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS ARM64 (M1/M2/M3)
          - os: macos
            arch: arm64
            runner: macos-14
            lightgbm_version: "4.6.0"
          - os: macos
            arch: arm64
            runner: macos-14
            lightgbm_version: "4.5.0"

          # macOS x86_64 (Intel)
          - os: macos
            arch: x86_64
            runner: macos-13
            lightgbm_version: "4.6.0"

          # Linux x86_64
          - os: linux
            arch: x86_64
            runner: ubuntu-latest
            lightgbm_version: "4.6.0"
          - os: linux
            arch: x86_64
            runner: ubuntu-latest
            lightgbm_version: "4.5.0"

          # Linux ARM64
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm64
            lightgbm_version: "4.6.0"

          # Windows x86_64
          - os: windows
            arch: x86_64
            runner: windows-latest
            lightgbm_version: "4.6.0"

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-${{ matrix.arch }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.arch }}-cargo-registry-

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-${{ matrix.arch }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.arch }}-cargo-index-

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-${{ matrix.arch }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.arch }}-cargo-build-target-

    - name: Install system dependencies (Linux)
      if: matrix.os == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libclang-dev

    - name: Check build (no features)
      env:
        LIGHTGBM_VERSION: ${{ matrix.lightgbm_version }}
      run: cargo check --verbose

    - name: Build (no features)
      env:
        LIGHTGBM_VERSION: ${{ matrix.lightgbm_version }}
      run: cargo build --verbose

    - name: Run tests (no features)
      env:
        LIGHTGBM_VERSION: ${{ matrix.lightgbm_version }}
      run: cargo test --verbose

    - name: Check build (with polars-support)
      env:
        LIGHTGBM_VERSION: ${{ matrix.lightgbm_version }}
      run: cargo check --features polars-support --verbose

    - name: Build (with polars-support)
      env:
        LIGHTGBM_VERSION: ${{ matrix.lightgbm_version }}
      run: cargo build --features polars-support --verbose

    - name: Run tests (with polars-support)
      env:
        LIGHTGBM_VERSION: ${{ matrix.lightgbm_version }}
      run: cargo test --features polars-support --verbose

    - name: Build examples
      env:
        LIGHTGBM_VERSION: ${{ matrix.lightgbm_version }}
      run: |
        cargo build --example basic_usage --verbose
        cargo build --example advanced_usage --verbose
        cargo build --example polars_usage --features polars-support --verbose

    - name: Verify library architecture (macOS)
      if: matrix.os == 'macos'
      run: |
        echo "Checking library architecture..."
        file target/debug/lib_lightgbm.dylib
        lipo -info target/debug/lib_lightgbm.dylib

    - name: Verify library architecture (Linux)
      if: matrix.os == 'linux'
      run: |
        echo "Checking library architecture..."
        file target/debug/lib_lightgbm.so
        readelf -h target/debug/lib_lightgbm.so | grep Machine

    - name: Verify library exists (Windows)
      if: matrix.os == 'windows'
      run: |
        echo "Checking library exists..."
        Get-Item target/debug/lib_lightgbm.dll

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy

    - name: Run clippy (no features)
      run: cargo clippy -- -D warnings

    - name: Run clippy (with polars-support)
      run: cargo clippy --features polars-support -- -D warnings

  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt

    - name: Check formatting
      run: cargo fmt -- --check

  # Test minimum supported LightGBM version
  min-version:
    name: Test minimum LightGBM version
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Test with LightGBM 4.0.0
      env:
        LIGHTGBM_VERSION: "4.0.0"
      run: |
        cargo check --verbose
        cargo build --verbose

  # Test unsupported platform (should fail gracefully)
  unsupported-platform:
    name: Test Windows ARM64 (unsupported)
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Add ARM64 target
      run: rustup target add aarch64-pc-windows-msvc

    - name: Test unsupported platform detection
      continue-on-error: true
      run: cargo build --target aarch64-pc-windows-msvc --verbose
      id: unsupported_build

    - name: Verify build failed with correct error
      if: steps.unsupported_build.outcome == 'failure'
      run: echo "Build failed as expected for Windows ARM64"
